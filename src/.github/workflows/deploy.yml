name: Deploy Cloudflare Worker
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Wrangler
        run: npm i -g wrangler

      - name: Set Cloudflare Auth
        run: echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV

      - name: Ensure KV namespace exists
        continue-on-error: true
        run: |
          wrangler kv namespace create STATUSES --env production || true
          wrangler kv namespace create STATUSES --env preview || true

      - name: Patch wrangler.toml with KV IDs
        run: |
          wrangler kv namespace list | tee namespaces.txt
          PROD_ID=$(cat namespaces.txt | grep '"title": "STATUSES (production)"' -A1 | grep '"id":' | sed -E 's/.*"id": "([^"]+)".*/\1/')
          PREV_ID=$(cat namespaces.txt | grep '"title": "STATUSES (preview)"' -A1 | grep '"id":' | sed -E 's/.*"id": "([^"]+)".*/\1/')
          sed -i "s/id = \"\"/id = \"$PROD_ID\"/" wrangler.toml
          sed -i "s/preview_id = \"\"/preview_id = \"$PREV_ID\"/" wrangler.toml

      - name: Put Worker Secret - API_BEARER
        run: |
          echo "${{ secrets.API_BEARER }}" | wrangler secret put API_BEARER --name ai-traffic-status --yes

      - name: Deploy
        run: wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
